### EAD7 暗号化システム 仕様書

#### 1. システム概要
EAD7は、マスターキーがすべてを掌握しつつも、現代の主要な暗号アルゴリズムに遜色ない強度を持つ暗号化システムです。主な目的は、暗号化と復号の機能を提供することです。

#### 2. 暗号化仕様

##### 2.1. 主要暗号アルゴリズム
*   **暗号本体**: **AES-256-GCM** が割り当てられています。AES-NIが利用可能な環境では高速ですが、非搭載環境向けにソフトウェア実装のフォールバックも検討されています。
*   **キー導出関数 (KDF)**: **HKDF-SHA256** を標準で採用しており、KEKおよびDEKは32バイト (256bit) の出力を生成します。saltは現状省略（0）で運用可能ですが、将来的には保存saltの使用を許容する設計です。
*   **メッセージ認証コード (MAC)**: **HMAC-SHA256** を使用します。
*   **マスターキー (MK) ラップ方式**: **libsodium** の機能を推奨しており、具体的には **Argon2id** と **XChaCha20-Poly1305 (AEAD)** を組み合わせてパスワードラップを行います。

##### 2.2. ヘッダ構造
暗号文のヘッダは以下のバイナリ順序で構成されます。
*   **Magic**: `E7` (2バイト)
*   **Version (ver)**: 1バイト
*   **Algorithm (alg)**: 1バイト
*   **Master Key ID (mkid)**: 1バイト
*   **Key ID (kid)**: 16バイト
*   **Nonce**: 12バイト
*   **Associated Authenticated Data (AAD)**: ヘッダ全体（magic/ver/alg/mkid/kid/nonce）を必ず渡します。

##### 2.3. 鍵階層と派生
EAD7の鍵階層は以下の通りです。
*   **MK (Master Key)** → **KEK (Key Encryption Key)** → **DEK (Data Encryption Key)**
*   MKからHMAC用キーも派生します.

##### 2.4. マスターキー (MK) の管理
*   **生成**: **CSPRNG** (AutoSeededRandomPool / libsodium `randombytes_buf`) を用いて**32バイト**のランダムな値を生成します。
*   **保存**: MKは**平文で保存せず**、LibsodiumのArgon2idとXChaCha20-Poly1305 (AEAD) を用いてパスワードでラップ（暗号化）して`mk_wrap.json`ファイルに保存します。保存ファイルは`MK.E7`というパスで管理されます.
*   **復元フロー**: パスワード入力 → `crypto_pwhash`で`wrapKey`導出 → AEAD復号 → MK復元。
*   **パラメータ**: Argon2idの`opslimit`と`memlimit`は`MODERATE`を使用します。
*   **セキュリティ**: メモリからの鍵情報の消去には`delm` (libsodium `sodium_memzero`) を使用します.

##### 2.5. KEK (Key Encryption Key) の管理
*   **用途**: 相手またはルームごとに固定の鍵です。
*   **生成**: KEK = **HKDF-SHA256( IKM=MK, salt=*, info="EAD7|KEK|<KID>" , L=32 )** で生成されます。saltは現状省略（0）です。
*   **配布方針**: KEKは開発者（MK所有者）が生成し、受信者の公開鍵ラップ（RSA-OAEP / ECIES）またはTLS経由で安全に配布することを推奨します。
*   **受信側保存**: OSの秘密ストアを優先し、利用できない場合は受信者のユーザパスワードでラップしてファイルに保存します。
*   **ファイル**: KEKは`mkid + ".kek.e7"`というパスでJSON形式で保存されます。このファイルは各エントリに `kid`, `nonce`, `ct`, `tag` を含みます。

##### 2.6. DEK (Data Encryption Key) の管理
*   **用途**: 暗号文ごとに変わる一時鍵です。
*   **生成**: DEK = **HKDF-SHA256( IKM=KEK, salt=*, info="EAD7|DEK|<Nonce>" , L=32 )** で生成されます。saltは現状省略（0）です。

##### 2.7. HMAC用キー (ファイル署名用)
*   **用途**: ファイル署名（KID一覧ファイルのHMAC検証など）に使用されます。
*   **生成**: HMACKey = **HKDF( IKM=MK, info="EAD7|KIDLIST-HMAC", L=32 )** で生成されます。`EAD7_2~3.md`およびソースコードの記述により、KEKから派生ではなくMKから直接派生する方針が採用されています。

##### 2.8. KID (Key ID / ルームID) の管理
*   **定義**: **16バイトのランダムな値**で、Base64表記では24文字固定となります。
*   **公開性**: KIDは暗号文に平文で埋め込んでも問題ありません（KID公開による復号不能への影響なし）。
*   **運用**: 相手ごとに固定（ルーム単位）で運用し、Nonceで暗号ごとの一意性を確保します。
*   **データ構造 (JSON)**:
    *   KIDエントリは、Base64エンコードされたKID（16Bのランダム値）をキーとし、以下のフィールドを持つJSONオブジェクトとして管理されます。
        *   `label`: ユーザー指定名
        *   `created`: 作成日時 (Unix時間)
        *   `status`: 鍵の状態。候補は`active` (利用可能), `inactive` (無効化済み), `revoked` (信用失効), `expired` (有効期限切れ)。
        *   `note`: 任意の備考
    *   内部ではKIDは常にバイナリ (BIN) で処理されますが、JSONではBase64URL-safe (b64u) 表記されます。
*   **KID一覧ファイル (`.kid.e7`) 仕様**:
    *   ファイルは`mkid + ".kid.e7"`というパスでJSON形式で保存されます。
    *   **HMAC検証**: ファイル全体（ボディ）に対する**HMAC-SHA256**のBase64表記が1行目に記述されます。HMAC検証対象のボディには改行も含まれ、保存時と検証時で完全に一致させる必要があります。
    *   **フォーマット**:
        ```json
        {
          "hmac": "HMAC-SHA256のBase64表記",
          "body": {
            "version": 1,
            "kids": {
              "KIDのBase64表記1": {
                "label": "ルーム名1",
                "created": 1724300000,
                "status": "active",
                "note": "備考1"
              },
              "KIDのBase64表記2": {
                "label": "ルーム名2",
                "created": 1724300000,
                "status": "active",
                "note": "備考2"
              }
            }
          }
        }
        ```
    *   **パースルール**: KIDエントリは`kids`オブジェクトのキーとしてBase64エンコードされたKIDを持ち、その値として`label`などの詳細情報を持つJSON構造です。
    *   **読み込み時の処理手順**:
        1.  ファイルを`ordered_json`として読み込む。
        2.  `hmac`フィールドと`body`フィールドが存在することを確認。
        3.  `hmac`フィールドから`hmac_stored`を読み取る。
        4.  `body`をJSON文字列としてダンプし、これを対象データとしてHMACKey (`MK`から導出) を用いてHMAC-SHA256 (`hmac_calc`) を計算。
        5.  `hmac_stored`と`hmac_calc`を比較し、不一致の場合は改ざん検出として処理を停止。
        6.  一致した場合は、`body`から各KIDエントリとルーム名を取り出す。

##### 2.9. 出力形式
*   **文字列用途**: **Base64** （URL-safeは任意）。
*   **ファイル用途**: **バイナリそのまま**。
*   **Nonce**: **96ビット (12バイト)** をランダムで毎回生成します。XChaCha20-Poly1305では**24バイト**のNonceを使用します。
*   **Tag**: **128ビット (16バイト)**。

##### 2.10. 具体値・推奨パラメータ
以下のパラメータはそのまま使用することを推奨します。
*   **MK長**: **32バイト**
*   **KID長**: **16バイト** (Base64で24文字)
*   **Nonce (AES-GCM)**: **12バイト**
*   **Tag (AES-GCM)**: **16バイト**
*   **HKDF**: SHA256, 出力長L=32バイト
*   **Argon2id (libsodium)**: `crypto_pwhash_OPSLIMIT_MODERATE`, `crypto_pwhash_MEMLIMIT_MODERATE` (個人利用向け)
*   **HMAC**: HMAC-SHA256, キーはHKDF(MK, info="EAD7|KIDLIST-HMAC")

#### 3. 運用手順とフロー

##### 3.1. 初回設定
1.  **MK生成**: CSPRNGでMKを生成。
2.  **MKラップ保存**: 生成したMKをパスワードでラップし、`mk_wrap.json` (`MK.E7`) に保存します。このファイルは安全にバックアップし、パーミッションを600に設定することを推奨します。オフラインバックアップ（USBなど）も必須です。

##### 3.2. 暗号化フロー (送信側)
1.  受信者のKIDを取得し、MKからKEKを導出: **KEK = HKDF(MK, info="EAD7|KEK|KID")**。
2.  Nonceを12バイトのランダム値として生成。
3.  KEKからDEKを導出: **DEK = HKDF(KEK, info="EAD7|DEK|nonce")**。
4.  **AES-256-GCM** を使用し、キー=DEK、Nonce=nonce、AAD=header で `ciphertext` と `tag` を生成。
5.  出力は **header || ciphertext || tag** の順序で結合し、テキストモードの場合はBase64エンコードします。

##### 3.3. 復号フロー (受信側)
1.  暗号文のヘッダからKIDとNonceを取り出す。
2.  KEKを参照（ローカルにない場合は配布/取得手順に従う）。
3.  KEKからDEKを導出: **DEK = HKDF(KEK, info="EAD7|DEK|nonce")**。
4.  AADヘッダとタグ検証を含め、**AES-GCM** で復号します。

##### 3.4. KEK配布方針
*   KEKは開発者（MK所有者）が生成し、TLSや公開鍵ラップ（RSA-OAEP / ECIES）を利用して配布します。
*   受信側では、OSの秘密ストアを利用できる場合は優先し、利用できない場合は受信者のユーザーパスワードでラップしてファイルに保存します。

##### 3.5. KID一覧の更新
1.  管理ツールでKID一覧 (`.kid.e7`のボディ部分) を編集。
2.  編集後のボディをJSON文字列としてダンプ。
3.  MKから導出したHMACKeyを用いて、ダンプしたボディに対するHMACを計算し、Base64エンコードして`hmac`フィールドに格納。
4.  JSON全体を`mkid + ".kid.e7"`として保存。

##### 3.6. MKローテーション (緊急時)
MKに疑念が生じた場合:
1.  新しいMKを生成。
2.  既存のKEKを新しいMKで再作成。
3.  KEKストアを新しいMKで再ラップ。
4.  古いMKファイルを安全に廃棄。

##### 3.7. 定期バックアップ
主要なファイル（`MK.E7`, `.kid.e7`, `.kek.e7`など）の定期的なバックアップは必須であり、少なくとも2箇所に保存することを推奨します。

#### 4. ファイルシステムと命名規則

##### 4.1. ベースディレクトリ
*   デフォルトのデータ保存場所: `%localappdata%/yy981/EAD7/` (`SD`)。

##### 4.2. 主要ファイル
*   **MKラップファイル**: `MK.E7` (旧`mk_wrap.json`)。管理者のみがアクセスし、マスターキーを管理します。
*   **KID一覧ファイル**: `mkid + ".kid.e7"` (旧`kid_list.txt`)。管理者のみがアクセスし、マスターキーごとのKEK-ID (KID) リストを管理します。
*   **KEKストアファイル**: `mkid + ".kek.e7"` (旧`kek_store.json`)。ユーザーが割り当てられたKEKを保持します。
*   **暗号文拡張子**: `*.ead7` を推奨。

##### 4.3. 内部データ表現
*   内部では、バイナリデータは`CryptoPP::SecByteBlock`を`BIN`として`typedef`したものに統一されます。
*   `BIN`は`randomBIN`関数によって生成されます。

#### 5. 開発・実装要件

##### 5.1. 推奨ライブラリ
*   **libsodium**: MKラップ（Argon2id + XChaCha20-Poly1305）に推奨されます。MSYS2では`mingw-w64-x86_64-libsodium`パッケージがあります。
*   **Crypto++**: HKDF, HMAC, AES-GCMの実装に推奨されます。MSYS2では`mingw-w64-x86_64-cryptopp`パッケージがあります。
*   **その他**: JSON処理には`nlohmann::json` (または`ordered_json`) を使用します。

##### 5.2. ビルド環境
*   **ビルドシステム**: **CMake** と **Ninja** を使用します。
*   **CMake設定**:
    *   `CMAKE_BUILD_TYPE Debug`
    *   `cmake_minimum_required(VERSION 3.16)`
    *   `CMAKE_CXX_STANDARD 23`
    *   `find_package(Qt6 REQUIRED COMPONENTS Core Gui Widgets OpenGLWidgets)`
    *   QtのMOC, RCC, UICの自動化設定 (`CMAKE_AUTOMOC ON`, `CMAKE_AUTORCC ON`, `CMAKE_AUTOUIC ON`)
    *   リンクライブラリ: `cryptopp`, `sodium`
    *   インクルードディレクトリ: `C:/msys64/mingw64/include/qt6`

##### 5.3. 実装チェックリスト (開発者向け)
*   [ ] libsodiumとCrypto++のインストール確認（MSYS2）
*   [ ] `mk_wrap`の読み書き実装（Wrap/Unwrapの対）
*   [ ] HKDF(MK + KID → KEK)のラッパー実装（Crypto++またはlibsodiumのHKDF実装）
*   [ ] DEK導出 (KEK + Nonce → DEK) 実装
*   [ ] AES-256-GCMのencrypt/decryptラッパー（AAD = header）
*   [ ] `kid_list`のHMAC署名/検証実装（HMACKey派生）
*   [ ] Base64/Hexデバッグヘルパ関数（Hexは大文字）
*   [ ] ファイルパーミッションとバックアップ処理追加
*   [ ] 単体テスト: 固定MK/KID/Nonceで暗号→復号ベクトルを作成しCIで監査

##### 5.4. 命名規則 (関数)
*   `load***`系: JSONやファイルからデータを読み込む関数
*   `create***`系: 新規生成（MKやKID）を行う関数

##### 5.5. エラーハンドリング
*   エラーハンドリングは基本的に**例外 (throw)** に統一します。

##### 5.6. よくある落とし穴 (要確認)
*   **Nonceの再利用は絶対にしない**（AES-GCMでは致命的）。Nonce生成方法はCSPRNGで毎回新規。
*   **AADの並び順を仕様で固定**。順序が変わると認証失敗する。
*   HMACの検証対象（ボディ）にファイル末尾の改行含めるなど、**保存と検証で完全一致**させる。
*   隠れた依存関係（例: Base64のvariantなど）について、**保存と検証で同一variantを使用**すること。
*   MKを複製して複数箇所に置く場合、**バックアップの暗号化管理も忘れない**こと。

##### 5.7. 今後の課題
*   KIDの生成関数実装 (`randomBIN`で16B乱数)
*   KEK/DEKとの結合処理（実際の暗号化・復号API）
*   ファイル暗号化やアイコン埋め込み（base64画像）は将来の拡張

##### 5.8. 現在の進捗
*   MK関連（生成・保存・復号・HMAC導出）はほぼ完成しています。
*   KID関連はI/O（読み書き）部分が完成済みで、生成処理はこれからです。
*   HMACKeyはMKからHKDFで導出する方針に決定しました。

#### 6. 補足

##### 6.1. 無視されるファイル/ディレクトリ (`.gitignore.txt`より)
*   `/build/`
*   `*.o`
*   `*.exe`
*   `.texter.bat`
*   `/o/`

---